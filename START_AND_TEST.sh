#!/bin/bash

# ACCESS PAL - Start and Test Script
# This script starts the server and provides testing instructions

echo "üöÄ ACCESS PAL - Push Notification Fix Applied!"
echo "=============================================="
echo ""

# Check if VAPID keys are configured
echo "üìã Checking VAPID Keys Configuration..."
cd /Users/mediad/access-pal/server
node -e "require('dotenv').config(); if (process.env.VAPID_PUBLIC_KEY && process.env.VAPID_PRIVATE_KEY && process.env.VAPID_SUBJECT) { console.log('‚úÖ All VAPID keys are configured correctly!'); } else { console.log('‚ùå ERROR: VAPID keys are missing!'); process.exit(1); }"

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå VAPID keys are not configured. Please check server/.env file."
    exit 1
fi

echo ""
echo "=============================================="
echo "üéØ PUSH NOTIFICATION FIX SUMMARY"
echo "=============================================="
echo ""
echo "‚úÖ Fixed: Added VAPID keys to server/.env"
echo "‚úÖ Fixed: Push notification service configured"
echo "‚úÖ Verified: All code components are in place"
echo ""
echo "=============================================="
echo "üìù TESTING INSTRUCTIONS"
echo "=============================================="
echo ""
echo "1. START THE SERVER:"
echo "   cd /Users/mediad/access-pal/server"
echo "   npm run dev"
echo ""
echo "2. START THE CLIENT (in new terminal):"
echo "   cd /Users/mediad/access-pal/client"
echo "   npm run dev"
echo ""
echo "3. TEST PUSH NOTIFICATIONS:"
echo "   a) Open http://localhost:3000/dashboard in browser"
echo "   b) Login with your credentials"
echo "   c) Grant notification permission when prompted"
echo "   d) Wait for console message: '‚úÖ Auto-subscribed to push notifications'"
echo "   e) Close the dashboard tab/window"
echo "   f) Open http://localhost:3000/visit/YOUR_QR_CODE_ID in another tab"
echo "   g) Click 'Start Video Call'"
echo "   h) Check for push notification on your device!"
echo ""
echo "4. CHECK SERVER LOGS:"
echo "   You should see:"
echo "   - üîîüîîüîî VISITOR-ALERT EVENT RECEIVED"
echo "   - üì± Sending push notification..."
echo "   - ‚úÖ Push notification sent successfully"
echo ""
echo "=============================================="
echo "üêõ TROUBLESHOOTING"
echo "=============================================="
echo ""
echo "If notification doesn't appear:"
echo "  ‚Ä¢ Check browser console for errors"
echo "  ‚Ä¢ Verify notification permission is granted"
echo "  ‚Ä¢ Check server logs for push errors"
echo "  ‚Ä¢ Try hard refresh (Cmd+Shift+R)"
echo "  ‚Ä¢ Clear browser data and try again"
echo ""
echo "For production testing:"
echo "  ‚Ä¢ Production already has VAPID keys in render.yaml"
echo "  ‚Ä¢ Deploy and test on actual devices"
echo "  ‚Ä¢ Check Render logs for confirmation"
echo ""
echo "=============================================="
echo "‚úÖ READY TO START!"
echo "=============================================="
echo ""
echo "Run these commands in separate terminals:"
echo ""
echo "Terminal 1 (Server):"
echo "  cd /Users/mediad/access-pal/server && npm run dev"
echo ""
echo "Terminal 2 (Client):"
echo "  cd /Users/mediad/access-pal/client && npm run dev"
echo ""
